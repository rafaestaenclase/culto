<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Botonera de Sonidos</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
  body { height: 80vh; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; background: #0f0f0f; color: #fff; }
  h2 { padding: 12px; margin-bottom: 10px; text-align: center; background: #181818; border-bottom: 1px solid #222; }
  #loader { height: 100vh; display: flex; align-items: center; justify-content: center; background: #0f0f0f; color: #ff9800; font-size: 20px; }
  .container { padding-bottom: 10px; }
  .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 0 10px; }
  button { aspect-ratio: 1 / 1; background: #222; border: none; border-radius: 12px; color: #fff; font-size: 14px; cursor: pointer; transition: transform 0.1s, background 0.2s, box-shadow 0.2s; }
  button:active { transform: scale(0.96); }
  button.active { background: #ff9800; box-shadow: 0 0 12px rgba(255, 152, 0, 0.7); color: #000; }
  button.music.active { background: #4caf50; box-shadow: 0 0 14px rgba(76, 175, 80, 0.8); color: #000; }
</style>
</head>
<body>

<div id="loader"><h2>Cargando sonidos...</h2></div>

<div id="app" style="display:none">
  <div class="container">
    <h2>Efectos</h2>
    <div id="effectsGrid" class="grid"></div>
  </div>

  <div class="container">
    <h2>MÃºsica</h2>
    <div id="musicGrid" class="grid"></div>
  </div>

  <div class="container">
    <h2>Ambiente</h2>
    <div id="ambienceGrid" class="grid"></div>
  </div>

</div>

<script>
/* ======================
   CONFIG
====================== */

const effects = [
  { title: 'ðŸ’§ Agua', src: './efx/agua.mp3' },
  { title: 'ðŸª¨ Piedra MoviÃ©ndose', src: './efx/moviendoPiedra.mp3' },
  { title: 'ðŸ”© Clavo Golpe', src: './efx/clavo.mp3' },
  { title: 'ðŸ’¥ Impacto Fuerte', src: './efx/impactante.mp3' },
  { title: 'ðŸŒ€ LÃ¡tigo', src: './efx/latigo.mp3' },
  { title: 'ðŸ˜¢ Llanto Mujer', src: './efx/llantoMujer.mp3' }
];


const musicas = [
  { title: 'ðŸŽ‰ Fiesta', src: './music/fiesta.mp3' },
  { title: 'ðŸ•Œ Ãrabe', src: './music/arabe.mp3' }
];


const ambientes = [
  { title: 'ðŸ“£ Abucheos', src: './ambient/genteAbucheos.mp3', loopSmooth: true },
  { title: 'ðŸ˜­ Multitud Llorando', src: './ambient/genteLlorando.mp3', loopSmooth: true },
  { title: 'ðŸ—£ï¸ Murmullo de Gente', src: './ambient/genteHablando.mp3', loopSmooth: true },
  { title: 'âš¡ Rayos y Tormenta', src: './ambient/rayos.mp3', loopSmooth: false },
  { title: 'ðŸ¥¾ Soldados Marchando', src: './ambient/soldadosMarchando.mp3', loopSmooth: true },
  { title: 'ðŸŒ‹ Temblores', src: './ambient/temblores.mp3', loopSmooth: true },
  { title: 'ðŸŒ¬ï¸ Viento del Desierto', src: './ambient/vientoDesierto.mp3', loopSmooth: true }
];




/* ======================
   PRELOAD
====================== */

function preloadAudio(src, loop = false) {
  return new Promise((resolve, reject) => {
    const audio = new Audio();
    audio.src = src;
    audio.loop = loop;
    audio.preload = 'auto';
    audio.addEventListener('canplaythrough', () => resolve(audio), { once: true });
    audio.addEventListener('loadedmetadata', () => resolve(audio), { once: true });
    audio.addEventListener('error', () => reject(`No se pudo cargar ${src}`), { once: true });
  });
}

async function preloadAll() {
  try {
    for (const e of effects) e.audio = await preloadAudio(e.src);
    for (const m of musicas) m.audio = await preloadAudio(m.src, true);
    for (const a of ambientes) a.audio = await preloadAudio(a.src, true);
    document.getElementById('loader').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initUI();
  } catch (err) {
    alert(err);
    console.error(err);
  }
}

/* ======================
   UI
====================== */

let currentMusic = null;
let currentMusicButton = null;
let fadeAnim = null;
let nextMusic = null;      // audio que va a sonar
let nextMusicButton = null; // botÃ³n visual del futuro audio

function fadeOut(audio, duration = 500) {
  return new Promise(resolve => {
    if (!audio) return resolve();
    let startVolume = audio.volume;
    let startTime = null;

    const step = (timestamp) => {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const fraction = Math.min(elapsed / duration, 1);
      audio.volume = startVolume * (1 - fraction);
      if (fraction < 1) {
        fadeAnim = requestAnimationFrame(step);
      } else {
        audio.pause();
        audio.currentTime = 0;
        audio.volume = startVolume;
        resolve();
      }
    };

    cancelAnimationFrame(fadeAnim); // cancela fade previo
    fadeAnim = requestAnimationFrame(step);
  });
}

function fadeIn(audio, duration = 800, targetVolume = 1) {
  audio.volume = 0;
  audio.play();

  let startTime = null;

  return new Promise(resolve => {
    const step = (timestamp) => {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const fraction = Math.min(elapsed / duration, 1);
      audio.volume = targetVolume * fraction;

      if (fraction < 1) {
        requestAnimationFrame(step);
      } else {
        resolve();
      }
    };
    requestAnimationFrame(step);
  });
}

function fadeOutAndStop(audio, duration = 800) {
  let startVolume = audio.volume;
  let startTime = null;

  return new Promise(resolve => {
    const step = (timestamp) => {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const fraction = Math.min(elapsed / duration, 1);
      audio.volume = startVolume * (1 - fraction);

      if (fraction < 1) {
        requestAnimationFrame(step);
      } else {
        audio.pause();
        audio.currentTime = 0; // ðŸ”¥ vuelve a 0
        audio.volume = startVolume;
        resolve();
      }
    };
    requestAnimationFrame(step);
  });
}


function initUI() {
  const effectsGrid = document.getElementById('effectsGrid');
  const musicGrid = document.getElementById('musicGrid');

  // Efectos (solapables)
  effects.forEach(effect => {
    const btn = document.createElement('button');
    btn.textContent = effect.title;
    btn.onclick = () => {
      const sound = effect.audio.cloneNode();
      btn.classList.add('active');
      sound.play();
      sound.onended = () => btn.classList.remove('active');
    };
    effectsGrid.appendChild(btn);
  });

  // MÃºsica con fade out / visual anticipada
  musicas.forEach(musica => {
    const btn = document.createElement('button');
    btn.textContent = musica.title;
    btn.classList.add('music');

    btn.onclick = async () => {

      // Toggle misma mÃºsica
      if (currentMusic === musica.audio) {
        await fadeOut(currentMusic);
        btn.classList.remove('active');
        currentMusic = null;
        currentMusicButton = null;
        nextMusic = null;
        nextMusicButton = null;
        return;
      }

      // Marcar botÃ³n futuro inmediatamente
      if (nextMusicButton && nextMusicButton !== btn) nextMusicButton.classList.remove('active');
      nextMusic = musica.audio;
      nextMusicButton = btn;
      btn.classList.add('active');

      // Fade out de la mÃºsica actual si existe
      if (currentMusic) {
        const prevButton = currentMusicButton;
        await fadeOut(currentMusic);
        if (prevButton) prevButton.classList.remove('active');
      }

      // Iniciar nueva mÃºsica
      currentMusic = nextMusic;
      currentMusicButton = nextMusicButton;
      nextMusic = null;
      nextMusicButton = null;

      currentMusic.volume = 1;
      currentMusic.currentTime = 0;
      currentMusic.play();
    };

    musicGrid.appendChild(btn);
  });


  // Ambiente (multi-play + toggle + fade in/out)
  const ambienceGrid = document.getElementById('ambienceGrid');

  ambientes.forEach(amb => {
    const btn = document.createElement('button');
    btn.textContent = amb.title;

    let isPlaying = false;
    let isFading = false;

    btn.onclick = async () => {
      if (isFading) return;
      isFading = true;

      if (!isPlaying) {
        btn.classList.add('active');
        if (amb.loopSmooth) {
          playSmoothLoop(amb.audio, 1.0); // 1s crossfade
        } else {
          await fadeIn(amb.audio, 800);
        }
        isPlaying = true;
      } else {
        await fadeOutAndStop(amb.audio, 800);
        btn.classList.remove('active');
        isPlaying = false;
      }

      isFading = false;
    };


    ambienceGrid.appendChild(btn);
  });
}

function playSmoothLoop(audio, fadeDuration = 1.0) {
  audio.volume = 1;
  audio.play();

  const fadeTime = fadeDuration * 1000; // en ms
  let fadeInterval = null;

  const scheduleLoop = () => {
    const timeLeft = audio.duration * 1000 - audio.currentTime * 1000;
    clearTimeout(fadeInterval);
    if (timeLeft > fadeTime) {
      fadeInterval = setTimeout(() => {
        // crea un clone para crossfade
        const nextAudio = audio.cloneNode();
        nextAudio.volume = 0;
        nextAudio.play();

        const start = performance.now();
        const step = (now) => {
          const elapsed = now - start;
          const fraction = Math.min(elapsed / fadeTime, 1);
          audio.volume = 1 - fraction;
          nextAudio.volume = fraction;
          if (fraction < 1) {
            requestAnimationFrame(step);
          } else {
            audio.pause();
            audio.currentTime = 0;
            // Reemplaza el audio original
            audio.src = nextAudio.src;
            audio.currentTime = nextAudio.currentTime;
            audio.volume = 1;
            scheduleLoop();
          }
        };
        requestAnimationFrame(step);
      }, timeLeft - fadeTime);
    }
  };

  scheduleLoop();
  return audio;
}



/* ======================
   START
====================== */

preloadAll();
</script>

</body>
</html>
